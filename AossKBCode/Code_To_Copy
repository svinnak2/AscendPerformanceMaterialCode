import os
import re

# Define input and output directories
input_dir = "/home/Converted_Code"
output_file = "/home/Converted_Code/combined_redshift_sql.txt"

# Initialize list to hold combined results
combined_output = []

# Loop through each file in the folder
for filename in os.listdir(input_dir):
    if filename.endswith(".txt"):
        # Extract transformation_name from file name
        match = re.match(r"resp_SQL_(.+?)_2025", filename)
        match = re.match(r"resp_SQL_(.+?)_2025.*", filename)
        if match:
            transformation_name = match.group(1)

            # Read the file content
            file_path = os.path.join(input_dir, filename)
            with open(file_path, "r", encoding="utf-8") as file:
                content = file.read()

            # Extract text between <RedShift_SQL> and </RedShift_SQL>, including tags
            rs_sql_match = re.search(r"(<RedShift_SQL>.*?</RedShift_SQL>)", content, re.DOTALL)
            if rs_sql_match:
                rs_sql_text = rs_sql_match.group(1)
                combined_output.append(f"Transformation: {transformation_name}\n{rs_sql_text}\n")

# Write the combined output to a single file
with open(output_file, "w", encoding="utf-8") as out_file:
    out_file.writelines(combined_output)

print(f"Combined file created at: {output_file}")
